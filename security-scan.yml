name: Infrastructure Security & Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. –°–¢–ê–¢–ò–ß–ù–ò–ô –ê–ù–ê–õ–Ü–ó (–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è 22 –ø–æ—Ä—Ç—É —Ç–∞ –ø—É–±–ª—ñ—á–Ω–∏—Ö S3)
  static-analysis:
    name: Security Scan (Checkov & tfsec)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # –ó–∞–ø—É—Å–∫ Checkov –∑ –≤–∞—à–∏–º–∏ –∫–∞—Å—Ç–æ–º–Ω–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          external_checks_dirs: checkov_rules
          check: CUSTOM_K8S_22,CKV_AWS_20,CKV_AWS_24
          soft_fail: false # –ü–†–û–í–ê–õ–ò–¢–ò –±—ñ–ª–¥, —è–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å

      # –ö–æ–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –ø—Ä—è–º–æ –≤ –∫–æ–¥—ñ Pull Request
      - name: tfsec PR commenter
        uses: tfsec/tfsec-pr-commenter-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # 2. –Ü–ù–¢–ï–ì–†–ê–¶–Ü–ô–ù–Ü –¢–ï–°–¢–ò (–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ Minikube/Kind)
  integration-tests:
    name: Terratest in Minikube
    needs: static-analysis # –ó–∞–ø—É—Å–∫ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Å—Ç–∞—Ç–∏–∫–∞ –ø—Ä–æ–π—à–ª–∞
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ K8s –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ CI
      - name: Setup Minikube (Kind)
        uses: helm/kind-action@v1.8.0

      - name: Run Terratest
        run: |
          cd test
          go mod tidy
          go test -v minikube_test.go

steps:
      # ... (–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∫—Ä–æ–∫–∏ Checkov —Ç–∞ Terratest) ...

      # –¶–µ–π –∫—Ä–æ–∫ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ (if: failure())
      - name: Send Slack Notification on Failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: alerts-security
          SLACK_COLOR: '#FF0000' # –ß–µ—Ä–≤–æ–Ω–∏–π –∫–æ–ª—ñ—Ä –¥–ª—è –ø–æ–º–∏–ª–∫–∏
          SLACK_ICON: https://github.com
          SLACK_TITLE: "üö® Security Violation Detected!"
          SLACK_MESSAGE: |
            *Repository:* ${{ github.repository }}
            *Author:* ${{ github.actor }}
            *Issue:* Checkov found open port 22 or public S3.
            *Action:* Deployment BLOCKED.
            *Details:* <https://github.com{{ github.run_id }}|View Logs>
